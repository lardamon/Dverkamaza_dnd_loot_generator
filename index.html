<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –õ—É—Ç–∞ D&D 5e</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="background.css" />
</head>
<body>
  <header class="app-header">
    <button id="menuBtn" class="btn icon" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ò∞</button>
    <div class="brand"><h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –õ—É—Ç–∞ D&D 5e</h1></div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row wrap gap">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="mode-battle">–ë–æ–π</button>
          <button class="tab" data-tab="mode-env">–û–∫—Ä—É–∂–µ–Ω–∏–µ</button>
          <button class="tab" data-tab="mode-music">–ú—É–∑—ã–∫–∞</button>
          <button class="tab" data-tab="mode-formulas">–§–æ—Ä–º—É–ª—ã</button>
        </div>
      </div>

      <!-- –ë–æ–π -->
      <div id="mode-battle" class="mode visible">
        <div class="row wrap gap">
          <div class="field">
            <label for="crInput" class="desktop-only">CR –º–æ–Ω—Å—Ç—Ä–∞</label>
            <input id="crInput" class="desktop-only" type="number" min="0" max="30" value="1" inputmode="numeric" />
            <label for="crSelect" class="mobile-only">CR –º–æ–Ω—Å—Ç—Ä–∞</label>
            <select id="crSelect" class="mobile-only"></select>
          </div>

          <div class="field">
            <label for="d20Input" class="desktop-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <input id="d20Input" class="desktop-only" type="number" min="1" max="20" placeholder="1‚Äì20" inputmode="numeric" />
            <label for="d20Select" class="mobile-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <select id="d20Select" class="mobile-only"></select>
          </div>

          <label class="one-line" style="display:flex;align-items:center;gap:8px;">
            <input id="bossCheck" type="checkbox" style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;"/>
            <span>–ë–æ—Å—Å (—É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç)</span>
          </label>
        </div>
      </div>

      <!-- –û–∫—Ä—É–∂–µ–Ω–∏–µ -->
      <div id="mode-env" class="mode">
        <div class="row wrap gap">
          <div class="field">
            <label for="containerSelect">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</label>
            <select id="containerSelect">
              <option value="small">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
              <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="large">–ë–æ–ª—å—à–æ–π</option>
            </select>
          </div>

          <div class="field">
            <label for="tierSelect">–î–∏–∞–ø–∞–∑–æ–Ω CR</label>
            <select id="tierSelect"></select>
          </div>

          <div class="field">
            <label for="d20InputEnv" class="desktop-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <input id="d20InputEnv" class="desktop-only" type="number" min="1" max="20" placeholder="1‚Äì20" inputmode="numeric" />
            <label for="d20SelectEnv" class="mobile-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <select id="d20SelectEnv" class="mobile-only"></select>
          </div>
        </div>
      </div>

      <!-- –ú—É–∑—ã–∫–∞ -->
      <div id="mode-music" class="mode">
        <div class="row wrap gap">
          <div class="field">
            <label for="musicCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="musicCategory"></select>
          </div>
        </div>
        <div class="music-controls mt">
          <div class="row gap">
            <button id="prevBtn" class="btn icon">‚èÆ</button>
            <button id="playBtn" class="btn icon">‚èØ</button>
            <button id="nextBtn" class="btn icon">‚è≠</button>
            <button id="shuffleBtn" class="btn">üîÄ</button>
            <button id="loopBtn" class="btn">üîÅ</button>
            <div class="row gap" style="align-items:center">
              <span class="hint">–ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
              <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="0.8"/>
            </div>
          </div>
          <div class="mt"><strong id="nowPlaying">–ù–∏—á–µ–≥–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç</strong></div>
        </div>
        <audio id="audio" preload="none"></audio>
      </div>

      <!-- –§–æ—Ä–º—É–ª—ã -->
      <div id="mode-formulas" class="mode">
        <div class="formula prose scroll">
          <h3>–ë–∞–∑–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª—ã</h3>
          <ul class="nice-list"><li>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä: (–ó–Ω–∞—á–µ–Ω–∏–µ ‚àí 10)/2, –≤–Ω–∏–∑.</li></ul>
        </div>
      </div>

      <div class="row wrap gap mt">
        <button id="generateBtn" class="btn primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª—É—Ç</button>
        <button id="copyBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="saveHistoryBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é</button>
      </div>
    </section>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <section id="resultCard" class="card">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
      <div class="grid cols-2 gap">
        <div>
          <h3>–ú–æ–Ω–µ—Ç—ã</h3>
          <ul id="coinsList" class="nice-list"></ul>
          <h3>–ú–µ–ª–∫–∏–µ –∫–∞–º–Ω–∏</h3>
          <ul id="smallGemsList" class="nice-list"></ul>
          <h3>–†–µ–¥–∫–∏–µ –∫–∞–º–Ω–∏</h3>
          <ul id="rareGemsList" class="nice-list"></ul>
        </div>
        <div>
          <h3>–ü—Ä–µ–¥–º–µ—Ç—ã</h3>
          <ul id="itemsList" class="nice-list"></ul>
          <h3>–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å</h3>
          <div class="total"><span id="totalValue">0</span> gp</div>
        </div>
      </div>
    </section>

    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ -->
    <section id="installCard" class="card" hidden>
      <h2>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
      <p class="hint">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω.</p>
      <div id="installHint" hidden><p>iOS: ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω ‚Äú–î–æ–º–æ–π‚Äù¬ª.</p></div>
      <button id="installBtn" class="btn primary" hidden>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </section>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside id="sidePanel" class="sidepanel left">
      <div class="side-header">
        <h2>–ú–µ–Ω—é</h2>
        <button id="closeMenuBtn" class="btn icon">‚úï</button>
      </div>
      <div class="side-tabs">
        <button class="stab active" data-panel="historyPanel">–ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="stab" data-panel="settingsPanel">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
      <div class="side-content">
        <section id="historyPanel" class="spanel visible">
          <div class="row wrap gap">
            <button id="exportHistoryBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
            <button id="clearHistoryBtn" class="btn danger">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
          </div>
          <ol id="historyList" class="history"></ol>
        </section>

        <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
        <section id="settingsPanel" class="spanel">
          <div class="field">
            <label for="hardnessRange">–£—Ä–æ–≤–µ–Ω—å ¬´–∂–µ—Å—Ç–∫–æ—Å—Ç–∏¬ª (–º–æ–Ω–µ—Ç—ã): <span id="hardnessLabel">1.0√ó</span></label>
            <input id="hardnessRange" type="range" min="0.5" max="3.0" step="0.1" value="1.0"/>
            <p class="hint">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫ –±—é–¥–∂–µ—Ç—É.</p>
          </div>

          <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
          <div class="field">
            <label>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</label>
            <div id="sourcesBox" class="row wrap gap" style="max-width:680px">
              <!-- –Ω–∞—Ç–∏–≤–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã (–Ω–∏–∫–∞–∫–∏—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤, —á—Ç–æ–±—ã CSS –Ω–µ –ª–æ–º–∞–ª) -->
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="DMG14" checked
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>DMG14</b> ‚Äî Dungeon Master's Guide</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="AI"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>AI</b> ‚Äî Acquisition Incorporated</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="BPGG"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>BPGG</b> ‚Äî Bigby Presents: Glory of the Giants</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="BMT"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>BMT</b> ‚Äî The Book of Many Things</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="RLW"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>RLW</b> ‚Äî Eberron: Rising from the Last War</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="EGW"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>EGW</b> ‚Äî Explorer's Guide to Wildemount</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="GGR"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>GGR</b> ‚Äî Guildmasters' Guide to Ravnica</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="TCE"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>TCE</b> ‚Äî Tasha's Cauldron of Everything</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;min-width:280px;">
                <input type="checkbox" value="XGE"
                  style="appearance:auto;-webkit-appearance:checkbox;width:16px;height:16px;">
                <span><b>XGE</b> ‚Äî Xanathar's Guide to Everything</span>
              </label>
            </div>
            <p class="hint">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á—ë–Ω —Ç–æ–ª—å–∫–æ <code>DMG14</code>. –ú–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</p>
          </div>

          <div class="field">
            <label for="maxItemsInput">–ú–∞–∫—Å–∏–º—É–º –ø—Ä–µ–¥–º–µ—Ç–æ–≤</label>
            <input id="maxItemsInput" type="number" min="1" max="3" value="1" />
          </div>

          <div class="row wrap gap">
            <button id="saveSettingsBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="resetSettingsBtn" class="btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </section>
      </div>
    </aside>

    <!-- –≤–µ—Ä—Å–∏—è –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ -->
    <footer style="text-align:center;margin:24px 0;opacity:.75;">
      <span id="version"></span>
    </footer>
  </main>

  <!-- –°–∫—Ä–∏–ø—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
  <script src="app.js" defer></script>
  <script src="version.js" defer></script>

  <!-- –ñ—ë—Å—Ç–∫–∏–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º -->
  <script>
  (function(){
    const LS_KEY = 'lootgen_allowed_sources';
    function readAllowed(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : null;
        if (Array.isArray(arr) && arr.length) return arr;
      }catch(e){}
      // –¥–µ—Ñ–æ–ª—Ç ‚Äî —Ç–æ–ª—å–∫–æ DMG14
      return ['DMG14'];
    }
    function collectFromUI(){
      const allowed = [];
      document.querySelectorAll('#sourcesBox input[type="checkbox"]').forEach(cb=>{
        if (cb.checked) allowed.push(cb.value);
      });
      if (!allowed.length) allowed.push('DMG14'); // –≤—Å–µ–≥–¥–∞ —Ö–æ—Ç—è –±—ã DMG14
      localStorage.setItem(LS_KEY, JSON.stringify(allowed));
      return allowed;
    }
    // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º localStorage -> UI –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function syncUI(){
      const allowed = new Set(readAllowed());
      document.querySelectorAll('#sourcesBox input[type="checkbox"]').forEach(cb=>{
        cb.checked = allowed.has(cb.value);
      });
    }
    // —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ —á–µ–∫–±–æ–∫—Å—ã
    function bindUI(){
      document.querySelectorAll('#sourcesBox input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change', collectFromUI);
      });
    }

    // –ü–ê–¢–ß: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ source_code.
    // –î–µ–ª–∞–µ–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ app.js.
    window.addEventListener('load', function applyPatch(){
      syncUI(); bindUI();

      const originalFC = window.filterCandidates;
      if (typeof originalFC === 'function'){
        window.filterCandidates = function(source, tierObj, rarityKey){
          const list = originalFC.call(this, source, tierObj, rarityKey) || [];
          const allowed = new Set(readAllowed());
          return list.filter(it => allowed.has(it.source_code));
        };
        return;
      }

      // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ filterCandidates –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞,
      // –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º generateLoot –∏ –≤—ã—á–∏—â–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ—Å–ª–µ –ø–æ–¥–±–æ—Ä–∞.
      const originalGL = window.generateLoot;
      if (typeof originalGL === 'function'){
        window.generateLoot = function(opts){
          const res = originalGL.call(this, opts) || {};
          const allowed = new Set(readAllowed());
          if (Array.isArray(res.items)){
            res.items = res.items.filter(it => allowed.has(it.source_code));
          }
          return res;
        };
      }
    });
  })();
  </script>

  <!-- SW (–∫–∞–∫ –±—ã–ª–æ) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
