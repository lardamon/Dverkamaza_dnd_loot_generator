<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –õ—É—Ç–∞ D&D 5e –æ—Ç –î–≤–µ—Ä—å–ö–∞–º–∞–∑–∞</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css?v=v2025-09-06-3" />
  <!-- –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å background.css ‚Äî –æ—Å—Ç–∞–≤—å —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ; –µ—Å–ª–∏ –Ω–µ—Ç, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å -->
  <link rel="stylesheet" href="background.css?v=v2025-09-06-3" />

  <meta name="description" content="–û—Ñ–ª–∞–π–Ω PWA –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ª—É—Ç–∞ D&D 5e –Ω–∞ —á–∏—Å—Ç–æ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å—Ç–µ–∫–µ. –†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, —É–º–µ–µ—Ç –±—é–¥–∂–µ—Ç, d20, CR –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã. –ü—Ä–æ—Å—Ç–æ–π HTML/CSS/JS, JSON-—Ç–∞–±–ª–∏—Ü—ã, –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏—Å—Ç–æ—Ä–∏—è." />
</head>
<body>
  <header class="app-header">
    <button id="menuBtn" class="btn icon" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" title="–ú–µ–Ω—é">‚ò∞</button>
    <div class="brand">
      <span class="logo">üé≤</span>
      <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –õ—É—Ç–∞ D&D 5e –æ—Ç –î–≤–µ—Ä—å–ö–∞–º–∞–∑–∞</h1>
    </div>
  </header>

  <main class="container">
    <!-- –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê -->
    <section class="card">
      <div class="row wrap gap">
        <div class="tabs" role="tablist" aria-label="–†–µ–∂–∏–º">
          <button class="tab active" role="tab" aria-selected="true" data-tab="mode-battle">–ë–æ–π</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="mode-env">–û–∫—Ä—É–∂–µ–Ω–∏–µ</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="mode-music">–ú—É–∑—ã–∫–∞</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="mode-formulas">–§–æ—Ä–º—É–ª—ã</button>
        </div>
      </div>

      <!-- –†–µ–∂–∏–º: –ë–æ–π -->
      <div id="mode-battle" class="mode visible">
        <div class="row wrap gap">
          <div class="field">
            <label for="crInput" class="desktop-only">CR –º–æ–Ω—Å—Ç—Ä–∞</label>
            <input id="crInput" class="desktop-only" type="number" inputmode="numeric" min="0" max="30" value="1" />
            <label for="crSelect" class="mobile-only">CR –º–æ–Ω—Å—Ç—Ä–∞</label>
            <select id="crSelect" class="mobile-only"></select>
          </div>

          <div class="field">
            <label for="d20Input" class="desktop-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <input id="d20Input" class="desktop-only" type="number" inputmode="numeric" min="1" max="20" placeholder="1‚Äì20" />
            <label for="d20Select" class="mobile-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <select id="d20Select" class="mobile-only"></select>
          </div>

          <label class="checkbox one-line">
            <input id="bossCheck" type="checkbox" />
            <span>–ë–æ—Å—Å (—É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç)</span>
          </label>
        </div>
      </div>

      <!-- –†–µ–∂–∏–º: –û–∫—Ä—É–∂–µ–Ω–∏–µ -->
      <div id="mode-env" class="mode">
        <div class="row wrap gap">
          <div class="field">
            <label for="containerSelect">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</label>
            <select id="containerSelect">
              <option value="small">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
              <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="large">–ë–æ–ª—å—à–æ–π</option>
            </select>
          </div>

          <div class="field">
            <label for="tierSelect">–î–∏–∞–ø–∞–∑–æ–Ω CR</label>
            <select id="tierSelect"></select>
          </div>

          <div class="field">
            <label for="d20InputEnv" class="desktop-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <input id="d20InputEnv" class="desktop-only" type="number" inputmode="numeric" min="1" max="20" placeholder="1‚Äì20" />
            <label for="d20SelectEnv" class="mobile-only">–†–µ–∑—É–ª—å—Ç–∞—Ç d20</label>
            <select id="d20SelectEnv" class="mobile-only"></select>
          </div>
        </div>
      </div>

      <!-- –†–µ–∂–∏–º: –ú—É–∑—ã–∫–∞ -->
      <div id="mode-music" class="mode">
        <div class="row wrap gap">
          <div class="field">
            <label for="musicCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="musicCategory"></select>
          </div>
        </div>
        <div class="music-controls mt">
          <div class="row gap">
            <button id="prevBtn" class="btn icon" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚èÆ</button>
            <button id="playBtn" class="btn icon" title="–ü—É—Å–∫/–ü–∞—É–∑–∞">‚èØ</button>
            <button id="nextBtn" class="btn icon" title="–°–ª–µ–¥—É—é—â–∏–π">‚è≠</button>
            <button id="shuffleBtn" class="btn" title="–®–∞—Ñ—Ñ–ª">üîÄ</button>
            <button id="loopBtn" class="btn" title="–ü–æ–≤—Ç–æ—Ä">üîÅ</button>
            <div class="row gap" style="align-items:center">
              <span class="hint">–ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
              <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="0.8" />
            </div>
          </div>
          <div class="mt">
            <strong id="nowPlaying">–ù–∏—á–µ–≥–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç</strong>
          </div>
        </div>

        <audio id="audio" preload="none"></audio>
      </div>

      <!-- –†–µ–∂–∏–º: –§–æ—Ä–º—É–ª—ã -->
      <div id="mode-formulas" class="mode">
        <div class="formula prose scroll">
          <h3>–ë–∞–∑–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª—ã D&D 5e</h3>
          <ul class="nice-list">
            <li><strong>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</strong> <code>(–ó–Ω–∞—á–µ–Ω–∏–µ ‚àí 10) / 2</code>, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–Ω–∏–∑.</li>
            <li><strong>–ö–î –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –±–µ–∑ –¥–æ—Å–ø–µ—Ö–∞:</strong> <code>10 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –õ–æ–≤–∫–æ—Å—Ç–∏</code></li>
            <li><strong>–ë–µ–∑–æ—Ä—É–∂–Ω—ã–π —É–¥–∞—Ä (–∞—Ç–∞–∫–∞):</strong> <code>1–∫20 + –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –°–∏–ª—ã</code></li>
            <li><strong>–£—Ä–æ–Ω –±–µ–∑–æ—Ä—É–∂–Ω–æ–≥–æ —É–¥–∞—Ä–∞:</strong> <code>1 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –°–∏–ª—ã</code></li>
            <li><strong>–†—É–∫–æ–ø–∞—à–Ω–∞—è –∞—Ç–∞–∫–∞ –æ—Ä—É–∂–∏–µ–º:</strong> <code>1–∫20 + –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –°–∏–ª—ã</code> <span class="hint">(–¥–ª—è —Ñ–µ—Ö—Ç–æ–≤–∞–ª—å–Ω–æ–≥–æ –º–æ–∂–Ω–æ –õ–æ–≤–∫–æ—Å—Ç—å)</span></li>
            <li><strong>–£—Ä–æ–Ω —Ä—É–∫–æ–ø–∞—à–Ω–æ–π –∞—Ç–∞–∫–∏ –æ—Ä—É–∂–∏–µ–º:</strong> <code>–∫–æ—Å—Ç–µ–π —É—Ä–æ–Ω–∞ –æ—Ä—É–∂–∏—è + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –°–∏–ª—ã</code> <span class="hint">(—Ñ–µ—Ö—Ç–æ–≤–∞–ª—å–Ω–æ–µ ‚Äî –º–æ–∂–Ω–æ –õ–æ–≤–∫–æ—Å—Ç—å)</span></li>
            <li><strong>–î–∞–ª—å–Ω–æ–±–æ–π–Ω–∞—è –∞—Ç–∞–∫–∞ –æ—Ä—É–∂–∏–µ–º:</strong> <code>1–∫20 + –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –õ–æ–≤–∫–æ—Å—Ç–∏</code> <span class="hint">(–º–µ—Ç–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Ç–æ—Ç –∂–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä, —á—Ç–æ –∏ –≤ —Ä—É–∫–æ–ø–∞—à–Ω–æ–π)</span></li>
            <li><strong>–£—Ä–æ–Ω –¥–∞–ª—å–Ω–æ–±–æ–π–Ω–æ–π –∞—Ç–∞–∫–∏ –æ—Ä—É–∂–∏–µ–º:</strong> <code>–∫–æ—Å—Ç–µ–π —É—Ä–æ–Ω–∞ –æ—Ä—É–∂–∏—è + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –õ–æ–≤–∫–æ—Å—Ç–∏</code> <span class="hint">(–º–µ—Ç–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Ç–æ—Ç –∂–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä, —á—Ç–æ –∏ –≤ —Ä—É–∫–æ–ø–∞—à–Ω–æ–π)</span></li>
            <li><strong>–ê—Ç–∞–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ–º:</strong> <code>1–∫20 + –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–∞–∑–æ–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</code></li>
            <li><strong>–£—Ä–æ–Ω –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è:</strong> <em>–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è</em></li>
            <li><strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å–ø–∞—Å–±—Ä–æ—Å–∫–∞ –æ—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è:</strong> <code>8 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–∞–∑–æ–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ + –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞</code></li>
            <li><strong>–ü–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–æ–≤ (–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞):</strong> <code>1–∫20 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –õ–æ–≤–∫–æ—Å—Ç–∏</code></li>
            <li><strong>–°–ø–∞—Å–±—Ä–æ—Å–æ–∫:</strong> <code>1–∫20 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</code> <span class="hint">(+ –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ –ø—Ä–∏ –≤–ª–∞–¥–µ–Ω–∏–∏)</span></li>
            <li><strong>–ü–∞—Å—Å–∏–≤–Ω–æ–µ –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ:</strong> <code>10 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ú—É–¥—Ä–æ—Å—Ç–∏ (–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ)</code></li>
            <li><strong>–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —É–º–∏—Ä–∞—é—â–µ–≥–æ:</strong> <code>1–∫20 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ú—É–¥—Ä–æ—Å—Ç–∏ (–ú–µ–¥–∏—Ü–∏–Ω–∞)</code> –ø—Ä–æ—Ç–∏–≤ <code>–°–ª 10</code></li>
            <li><strong>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:</strong> <code>1–∫20 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</code> <span class="hint">(+ –±–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ –ø—Ä–∏ –≤–ª–∞–¥–µ–Ω–∏–∏)</span></li>
          </ul>
        </div>
      </div>

      <div class="row wrap gap mt">
        <button id="generateBtn" class="btn primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª—É—Ç</button>
        <button id="copyBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="saveHistoryBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é</button>
      </div>
    </section>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <section id="resultCard" class="card">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
      <div class="grid cols-2 gap">
        <div>
          <h3>–ú–æ–Ω–µ—Ç—ã</h3>
          <ul id="coinsList" class="nice-list"></ul>

          <h3>–ú–µ–ª–∫–∏–µ –∫–∞–º–Ω–∏</h3>
          <ul id="smallGemsList" class="nice-list"></ul>

          <h3>–†–µ–¥–∫–∏–µ –∫–∞–º–Ω–∏</h3>
          <ul id="rareGemsList" class="nice-list"></ul>
        </div>
        <div>
          <h3>–ü—Ä–µ–¥–º–µ—Ç—ã</h3>
          <ul id="itemsList" class="nice-list"></ul>

          <h3>–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å</h3>
          <div class="total"><span id="totalValue">0</span> gp</div>
        </div>
      </div>
    </section>

    <!-- –£–°–¢–ê–ù–û–í–ö–ê PWA -->
    <section id="installCard" class="card" hidden>
      <h2>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
      <p class="hint">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω, –¥–æ—Å—Ç—É–ø —Å —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞, –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç.</p>
      <div id="installHint" hidden>
        <p>–ù–∞ iOS: –Ω–∞–∂–º–∏ <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚Üí <strong>–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª</strong>.</p>
      </div>
      <button id="installBtn" class="btn primary" hidden>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </section>
  </main>

  <!-- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
  <aside id="sidePanel" class="sidepanel left">
    <div class="side-header">
      <h2>–ú–µ–Ω—é</h2>
      <button id="closeMenuBtn" class="btn icon" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
    <div class="side-tabs">
      <button class="stab active" data-panel="historyPanel">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="stab" data-panel="settingsPanel">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="side-content">
      <section id="historyPanel" class="spanel visible">
        <div class="row wrap gap">
          <button id="exportHistoryBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
          <button id="clearHistoryBtn" class="btn danger">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
        <ol id="historyList" class="history"></ol>
      </section>

      <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
      <section id="settingsPanel" class="spanel">
        <div class="field">
          <label for="hardnessRange">–£—Ä–æ–≤–µ–Ω—å ¬´–∂–µ—Å—Ç–∫–æ—Å—Ç–∏¬ª (–º–æ–Ω–µ—Ç—ã): <span id="hardnessLabel">1.0√ó</span></label>
          <input id="hardnessRange" type="range" min="0.5" max="3.0" step="0.1" value="1.0" />
          <p class="hint">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫ –±—é–¥–∂–µ—Ç—É –∏ –º–æ–Ω–µ—Ç–∞–º (0.5√ó‚Ä¶3.0√ó). 1.0 ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.</p>
        </div>

        <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
        <div class="field">
          <label>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</label>
          <div id="sourcesBox" class="row wrap gap">
            <!-- —á–µ–∫–±–æ–∫—Å—ã –æ—Ç—Ä–∏—Å—É–µ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∏–∂–µ -->
          </div>
          <p class="hint">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á—ë–Ω —Ç–æ–ª—å–∫–æ <code>DMG14</code>. –û—Ç–º–µ—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.</p>
        </div>

        <div class="field">
          <label for="maxItemsInput">–ú–∞–∫—Å–∏–º—É–º –ø—Ä–µ–¥–º–µ—Ç–æ–≤</label>
          <input id="maxItemsInput" type="number" min="1" max="3" value="1" />
        </div>

        <div class="row wrap gap">
          <button id="saveSettingsBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="resetSettingsBtn" class="btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </section>
    </div>
  </aside>

  <!-- –°–ö–†–ò–ü–¢–´ -->
  <script src="app.js?v=v2025-09-06-3" defer></script>

  <!-- –§–∏–ª—å—Ç—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: UI + –ø–∞—Ç—á –∫ filterCandidates (–æ—Å—Ç–∞–≤–ª—è–µ–º app.js –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º) -->
  <script>
  (function(){
    const LS_KEY = 'lootgen_allowed_sources';
    const SOURCE_OPTIONS = [
      { code:'DMG14', title:"Dungeon Master's Guide" },
      { code:'AI',    title:'Acquisition Incorporated' },
      { code:'BPGG',  title:'Bigby Presents: Glory of the Giants' },
      { code:'BMT',   title:'The Book of Many Things' },
      { code:'RLW',   title:'Eberron: Rising from the Last War' },
      { code:'EGW',   title:"Explorer's Guide to Wildemount" },
      { code:'GGR',   title:"Guildmasters' Guide to Ravnica" },
      { code:'TCE',   title:"Tasha's Cauldron of Everything" },
      { code:'XGE',   title:"Xanathar's Guide to Everything" }
    ];

    function loadAllowed(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : null;
        if (Array.isArray(arr) && arr.length) return arr;
      } catch {}
      return ['DMG14']; // –¥–µ—Ñ–æ–ª—Ç
    }
    function saveAllowed(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    function renderSourcesUI(){
      const box = document.getElementById('sourcesBox');
      if (!box) return;
      const allowed = new Set(loadAllowed());
      box.innerHTML = '';
      SOURCE_OPTIONS.forEach(opt => {
        const id = 'src_' + opt.code;
        const label = document.createElement('label');
        label.className = 'checkbox one-line';
        label.style.minWidth = '220px';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = opt.code;
        input.id = id;
        input.checked = allowed.has(opt.code);

        const span = document.createElement('span');
        span.innerHTML = `<strong>${opt.code}</strong> <span class="hint">‚Äî ${opt.title}</span>`;

        input.addEventListener('change', () => {
          const current = new Set(loadAllowed());
          if (input.checked) current.add(opt.code); else current.delete(opt.code);
          if (current.size === 0) { current.add('DMG14'); document.getElementById('src_DMG14').checked = true; }
          saveAllowed([...current]);
        });

        label.appendChild(input);
        label.appendChild(span);
        box.appendChild(label);
      });
    }

    // –º—è–≥–∫–∏–π –ø–∞—Ç—á: —É—Å–∏–ª–∏–≤–∞–µ–º filterCandidates –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ source_code
    function patchFilter(){
      if (typeof window.filterCandidates !== 'function') {
        setTimeout(patchFilter, 50);
        return;
      }
      const original = window.filterCandidates;
      window.filterCandidates = function(source, tierObj, rarityKey){
        const list = original.call(this, source, tierObj, rarityKey) || [];
        const allowedSet = new Set(loadAllowed());
        return list.filter(it => allowedSet.has(it.source_code));
      };
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderSourcesUI();
      patchFilter();
    });
  })();
  </script>

  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW (–∫–∞–∫ —É —Ç–µ–±—è) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => {
            // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ reload
            reg.addEventListener('updatefound', () => {
              const nw = reg.installing;
              nw?.addEventListener('statechange', () => {
                if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                  nw.postMessage({ type: 'SKIP_WAITING' });
                }
              });
            });
          })
          .catch(console.error);
      });
    }
  </script>
</body>
</html>
